name: CI

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-20.04
    strategy:
      fail-fast: false
      matrix:
        image:
          - ubuntu-daily:focal
          - ubuntu-daily:jammy
          - ubuntu-daily:kinetic
          - ubuntu-daily:lunar
          - ubuntu-daily:mantic
    steps:
    - uses: actions/checkout@v2
    - name: run
      run: sudo ./scripts/test-in-lxd.sh ${{ matrix.image }} "make check"
  lint:
    runs-on: ubuntu-20.04
    strategy:
      fail-fast: false
      matrix:
        image:
          - ubuntu-daily:jammy    # match the core snap we're running against
          - ubuntu-daily:mantic   # latest
    steps:
    - uses: actions/checkout@v2
    - name: lint
      run: sudo ./scripts/test-in-lxd.sh ${{ matrix.image }} "make lint"

  static-typing:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-22.04
    steps:
      - name: Install mypy and typeshed
        run: sudo apt-get install -y python3-mypy python3-typeshed
      - name: Checkout the source branch
        uses: actions/checkout@v3
      - name: Run mypy on source branch
        run: python3 -m mypy --ignore-missing-imports --check-untyped-defs subiquity subiquitycore system_setup console_conf scripts/replay-curtin-log.py | tee /tmp/mypy-source.out
      - name: Checkout the target/base branch
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.base.ref }}
      - name: Run mypy on target/base branch
        run: python3 -m mypy --ignore-missing-imports --check-untyped-defs subiquity subiquitycore system_setup console_conf scripts/replay-curtin-log.py | tee /tmp/mypy-target.out
      - name: Produce the diff between the two mypy runs
        run: diff --color=always --unified=0 /tmp/mypy-target.out /tmp/mypy-source.out
        continue-on-error: true
