name: CI

on: [push, pull_request]

jobs:
  static-typing:
    # In this job, we compare the output of mypy before and after the PR.
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-22.04
    steps:
      - name: Install mypy and typeshed
        run: sudo apt-get install -y python3-mypy python3-typeshed
      - name: Checkout the pull request branch
        uses: actions/checkout@v3
        with:
          ref: "${{ github.event.pull_request.head.sha }}"
          fetch-depth: "${{ github.event.pull_request.commits }}"
      - run: git remote -v
      - name: Run mypy on pull request branch
        run: python3 -m mypy --ignore-missing-imports --check-untyped-defs subiquity subiquitycore system_setup console_conf scripts/replay-curtin-log.py | tee /tmp/mypy-head.out
      - name: Determine base commit (most recent common ancestor)
        id: determine_base_commit
        run: |
          ancestor=$(git merge-base -- \
              "${{ github.event.pull_request.base.sha }}" \
              "${{ github.event.pull_request.head.sha }}")
          echo "base_commit=$ancestor" >> "$GITHUB_OUTPUT"
      - name: Checkout the base commit (most recent common ancestor)
        uses: actions/checkout@v3
        with:
          ref: ${{ steps.determine_base_commit.outputs.base_commit }}
      - run: git show
      - name: Run mypy on base commit
        run: python3 -m mypy --ignore-missing-imports --check-untyped-defs subiquity subiquitycore system_setup console_conf scripts/replay-curtin-log.py | tee /tmp/mypy-base.out
      - name: Produce the diff between the two mypy runs
        run: diff --color=always --unified=0 /tmp/mypy-base.out /tmp/mypy-head.out
        continue-on-error: true
